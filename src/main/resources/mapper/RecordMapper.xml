<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.notify.infra.mapper.RecordMapper">

    <select id="fulltextSearchEmail" resultType="io.choerodon.notify.api.dto.RecordListDTO">
        SELECT
        rc.id,
        rc.status,
        rc.receive_account AS email,
        rc.retry_count,
        nts.is_manual_retry,
        tl.name AS template_type,
        rc.failed_reason,
        rc.creation_date
        FROM notify_record rc
        LEFT JOIN notify_send_setting nts ON nts.code = rc.business_type
        LEFT JOIN notify_template tl ON rc.template_id = tl.id
        WHERE rc.status IS NOT NULL
        <if test="searchVO.level != null">
            AND nts.fd_level = #{searchVO.level}
        </if>
        <if test="searchVO.status != null">
            AND rc.status = #{searchVO.status}
        </if>
        <if test="searchVO.receiveEmail != null">
            AND rc.receive_account LIKE concat(concat('%',#{searchVO.receiveEmail}),'%')
        </if>
        <if test="searchVO.templateType != null">
            AND tl.name LIKE concat(concat('%',#{searchVO.templateType}),'%')
        </if>
        <if test="searchVO.failedReason != null">
            AND rc.failed_reason LIKE concat(concat('%',#{searchVO.failedReason}),'%')
        </if>
        <if test="param != null">
            AND(
            tl.name LIKE concat(concat('%',#{param}),'%') OR
            rc.receive_account LIKE concat(concat('%',#{param}),'%') OR
            rc.failed_reason LIKE concat(concat('%',#{param}),'%')
            )
        </if>
        order by rc.id desc
    </select>

    <update id="updateRecordStatusAndIncreaseCount">
        UPDATE notify_record
        SET object_version_number = object_version_number + 1,
        status = #{status}, failed_reason = #{reason}
        <if test="increase">
            , retry_count = retry_count + 1
        </if>
        <if test="date != null">
            , creation_date = #{date}
        </if>
        WHERE id = #{id}
    </update>

</mapper>
