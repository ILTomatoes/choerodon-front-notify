<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="io.choerodon.notify.infra.mapper.MessageSettingMapper">

    <resultMap type="io.choerodon.notify.infra.dto.MessageSettingDTO" id="messageSettingDTO">
        <id column="id" property="id"/>
        <result column="NOTIFY_TYPE" property="notifyType"/>
        <result column="PROJECT_ID" property="projectId"/>
        <result column="PM_ENABLE" property="pmEnable"/>
        <result column="EMAIL_ENABLE" property="emailEnable"/>
        <result column="CATEGORY" property="category"/>
        <result column="CODE" property="code"/>
        <result column="NAME" property="name"/>
        <result  column="OBJECT_VERSION_NUMBER" property="objectVersionNumber"/>
        <association property="targetUserDTO" javaType="io.choerodon.notify.infra.dto.TargetUserDTO">
            <id column="id" property="id"/>
            <result column="TYPE" property="type"/>
            <result column="USER_ID" property="userId"/>
            <result column="MESSAGE_SETTING_ID" property="messageSettingId"/>
            <result column="U_OBJECT_VERSION_NUMBER" property="objectVersionNumber" />
        </association>
    </resultMap>

    <select id="listMessageSettingByCondition" resultMap="messageSettingDTO">
         SELECT
         nms.ID,
         nms.NOTIFY_TYPE,
         nms.`CODE`,
         nms.PROJECT_ID,
         nms.PM_ENABLE,
         nms.EMAIL_ENABLE,
         nssc.name AS CATEGORY,
		 ntu.TYPE,
		 ntu.USER_ID,
		 nms.OBJECT_VERSION_NUMBER,
		 ntu.MESSAGE_SETTING_ID,
         nss.name,
		 ntu.OBJECT_VERSION_NUMBER AS U_OBJECT_VERSION_NUMBER
         FROM notify_message_setting nms
		 JOIN notify_send_setting    nss
		 ON nms.`CODE`=nss.`CODE`
		 JOIN notify_send_setting_category nssc
		 ON nss.CATEGORY_CODE=nssc.`CODE`
		 JOIN notify_target_user ntu
		 ON nms.ID=ntu.MESSAGE_SETTING_ID
		 WHERE 1=1
        <if test="messageSettingDTO.name !=null and messageSettingDTO.name !=''">
            and nss.name like "%"#{messageSettingDTO.name}"%"
        </if>
		and  nms.NOTIFY_TYPE=#{messageSettingDTO.notifyType}
    </select>
</mapper>
